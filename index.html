<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI对话详情</title>
  <!-- Bootstrap 5 CSS -->
  <link href="/static/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
      padding-top: 20px;
    }

    .card {
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .question-card {
      border-left: 4px solid #0d6efd;
    }

    .answer-card {
      border-left: 4px solid #198754;
      margin-top: 20px;
    }

    .badge-status {
      font-size: 0.9em;
      padding: 6px 12px;
    }

    .text-content {
      white-space: pre-wrap;
      line-height: 1.6;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10 col-xl-8">
        <!-- 头部信息 -->
        <div class="card mb-4">
          <div class="card-body">
            <h4 class="card-title">AI对话详情</h4>
            <div class="row mt-3">
              <div class="col-md-3">
                <small class="text-muted">ID</small>
                <div class="fw-bold" id="id">-</div>
              </div>
              <div class="col-md-3">
                <small class="text-muted">状态</small>
                <div id="status"></div>
              </div>
              <div class="col-md-3">
                <small class="text-muted">提交时间</small>
                <div id="date">-</div>
              </div>
              <div class="col-md-3">
                <small class="text-muted">AI处理时间</small>
                <div id="ai_date">-</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card question-card mb-3">
          <div class="card-body">
            <h5 class="card-title text-primary">本次提交内容</h5>
            <div class="text-content mt-3" id="question">加载中...</div>
          </div>
        </div>

        <div class="card answer-card">
          <div class="card-body">
            <h5 class="card-title text-success">AI代码分析</h5>
            <div class="text-content mt-3" id="answer">加载中...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery -->
  <script src="/static/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="/static/bootstrap.bundle.min.js"></script>

  <script>
    $(document).ready(function () {
      const statusMap = {
        0: { text: '待处理', class: 'bg-primary' },
        1: { text: '已处理', class: 'bg-success' },
        2: { text: '处理中', class: 'bg-warning' },
        3: { text: '失败', class: 'bg-danger' }
      };

      function getConversationId() {
        const path = window.location.pathname;
        const match = path.match(/\/report\/(\d+)/);
        if (match)
          return match[1]
        return null
      }

      function loadData() {
        const conversationId = getConversationId();

        if (!conversationId) {
          $('#question').text('错误：URL中未指定对话ID');
          return;
        }

        $.ajax({
          url: `/api/quest/${conversationId}`,
          method: 'GET',
          success: function (v) {
            const data = v.result[0] || {};
            // 填充数据
            $('#id').text(data.hash || conversationId);
            $('#date').text(data.date);
            $('#ai_date').text(data.ai_date);
            $('#question').text(data.question || '');
            $('#answer').text(data.answer || '');

            // 设置状态
            const status = data.status || 0;
            const statusInfo = statusMap[status] || statusMap[0];
            $('#status').html(`<span class="badge badge-status ${statusInfo.class}">${statusInfo.text}</span>`);

            // 更新标题
            document.title = `AI对话 - ${conversationId}`;
          },
          error: function (xhr) {
            const errorMsg = xhr.status === 404 ? '对话不存在' : '加载失败';
            $('#question').text(`${errorMsg} (ID: ${conversationId})`);
          }
        });
      }

      // 页面加载完成后执行
      loadData();
    });
  </script>
</body>

</html>